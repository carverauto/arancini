name: Publish Crates

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Run cargo publish --dry-run only"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"
  push:
    tags:
      - "v*"

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    runs-on: ubuntu-latest
    environment: main
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install system deps
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev libsasl2-dev libssl-dev capnproto

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo artifacts
        uses: Swatinem/rust-cache@v2

      - name: Validate workspace
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace --all-targets --all-features -- -D warnings
          cargo test --workspace --locked --verbose

      - name: Package check (arancini-lib)
        run: cargo package -p arancini-lib --locked

      - name: Publish arancini-lib
        run: |
          if [ "$DRY_RUN" = "true" ]; then
            cargo publish -p arancini-lib --locked --dry-run
          else
            set +e
            out=$(cargo publish -p arancini-lib --locked 2>&1)
            rc=$?
            set -e
            echo "$out"
            if [ $rc -ne 0 ]; then
              if echo "$out" | grep -q "already exists on crates.io index"; then
                echo "arancini-lib already published; continuing."
              else
                exit $rc
              fi
            fi
          fi

      - name: Wait for index propagation
        if: env.DRY_RUN != 'true'
        run: sleep 30

      - name: Package check (arancini)
        if: env.DRY_RUN != 'true'
        run: |
          for i in {1..12}; do
            if cargo package -p arancini --locked; then
              exit 0
            fi
            echo "arancini package check failed (attempt $i), waiting for crates index..."
            sleep 15
          done
          echo "arancini package check failed after retries"
          exit 1

      - name: Publish arancini
        if: env.DRY_RUN != 'true'
        run: |
          for i in {1..12}; do
            set +e
            out=$(cargo publish -p arancini --locked 2>&1)
            rc=$?
            set -e
            echo "$out"
            if [ $rc -eq 0 ]; then
              exit 0
            fi
            if echo "$out" | grep -q "already exists on crates.io index"; then
              echo "arancini already published; continuing."
              exit 0
            fi
            echo "arancini publish failed (attempt $i), waiting for crates index..."
            sleep 15
          done
          echo "arancini publish failed after retries"
          exit 1

      - name: Note dry-run limitation
        if: env.DRY_RUN == 'true'
        run: |
          echo "Dry-run published/validated arancini-lib only."
          echo "arancini publish checks require arancini-lib on crates.io and are skipped in dry-run mode."
